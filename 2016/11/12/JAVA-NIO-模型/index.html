<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="大家都在说同步IO、异步IO、阻塞IO、非阻塞IO，本人对其中的有些知识也是有些模糊，借此机会决定研究一下。本文旨在澄清、说明和探讨 JAVA  I/O的几点基本概念和知识，以及各种IO模型的优缺点，欢迎讨论。">
<meta property="og:type" content="article">
<meta property="og:title" content="JAVA NIO 模型">
<meta property="og:url" content="http://yoursite.com/2016/11/12/JAVA-NIO-模型/index.html">
<meta property="og:site_name" content="Mr岳的技术博客">
<meta property="og:description" content="大家都在说同步IO、异步IO、阻塞IO、非阻塞IO，本人对其中的有些知识也是有些模糊，借此机会决定研究一下。本文旨在澄清、说明和探讨 JAVA  I/O的几点基本概念和知识，以及各种IO模型的优缺点，欢迎讨论。">
<meta property="og:image" content="http://yoursite.com/uploads/内核空间和用户控件.png">
<meta property="og:image" content="http://yoursite.com/uploads/阻塞IO.png">
<meta property="og:image" content="http://yoursite.com/uploads/非阻塞IO.png">
<meta property="og:image" content="http://yoursite.com/uploads/多路IO复用模型.png">
<meta property="og:image" content="http://yoursite.com/uploads/信号驱动IO模型.png">
<meta property="og:image" content="http://yoursite.com/uploads/异步IO模型.png">
<meta property="og:image" content="http://yoursite.com/uploads/五中IO模型区别.png">
<meta property="og:image" content="http://yoursite.com/uploads/BIO.png">
<meta property="og:image" content="http://yoursite.com/uploads/N-NIO.png">
<meta property="og:image" content="http://yoursite.com/uploads/NIO-Reactor单线程模型.png">
<meta property="og:updated_time" content="2016-11-13T06:49:23.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JAVA NIO 模型">
<meta name="twitter:description" content="大家都在说同步IO、异步IO、阻塞IO、非阻塞IO，本人对其中的有些知识也是有些模糊，借此机会决定研究一下。本文旨在澄清、说明和探讨 JAVA  I/O的几点基本概念和知识，以及各种IO模型的优缺点，欢迎讨论。">
<meta name="twitter:image" content="http://yoursite.com/uploads/内核空间和用户控件.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2016/11/12/JAVA-NIO-模型/"/>

  <title> JAVA NIO 模型 | Mr岳的技术博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?14dfdac6b6d6b979cf81aeb8139f10c2";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Mr岳的技术博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                JAVA NIO 模型
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-11-12T23:52:49+08:00" content="2016-11-12">
              2016-11-12
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/11/12/JAVA-NIO-模型/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/12/JAVA-NIO-模型/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/11/12/JAVA-NIO-模型/" class="leancloud_visitors" data-flag-title="JAVA NIO 模型">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>大家都在说同步IO、异步IO、阻塞IO、非阻塞IO，本人对其中的有些知识也是有些模糊，借此机会决定研究一下。<br>本文旨在澄清、说明和探讨 JAVA  I/O的几点基本概念和知识，以及各种IO模型的优缺点，欢迎讨论。</p>
</blockquote>
<a id="more"></a>
<h1 id="JAVA-NIO-模型"><a href="#JAVA-NIO-模型" class="headerlink" title="JAVA NIO 模型"></a>JAVA NIO 模型</h1><hr>
<p>在探讨<code>JAVA</code> <code>I/O</code>模型之前，我们先来说一下<code>Linux</code>上的几种<code>I/O</code>模型及其区别。</p>
<hr>
<h2 id="Linux-网络-I-O-模型"><a href="#Linux-网络-I-O-模型" class="headerlink" title="Linux 网络 I/O 模型"></a><code>Linux 网络 I/O 模型</code></h2><p>首先，对一个<code>IO</code>的访问，数据首先会被拷贝到操作系统内核的缓冲区中，然后才会从操作系统内核的缓冲区拷贝到应用进程的缓冲区。因此一个<code>IO</code>操作会经历两个阶段（如图）：</p>
<blockquote>
<ul>
<li>等待数据准备（将数据拷贝到内核缓冲区）</li>
<li>将数据从内核拷贝到应用进程缓冲区</li>
</ul>
</blockquote>
<p><img src="/uploads/内核空间和用户控件.png" alt="Alt text"></p>
<blockquote>
<p>附：<br>1、 <a href="http://blog.csdn.net/bingqingsuimeng/article/details/7924756" target="_blank" rel="external">用户空间和内核空间</a><br>2、文件文件描述符 ： Linux对文件的读写会返回一个file <code>descripeor</code>（fd，文件描述符）；  对一个<code>socket</code>的读写也会返回相应的描述符：<code>socketfd</code>（<code>socket</code>描述符）。<br>这些描述符就是一个数字，它指向内核为每一个进程所维护的该进程打开文件的记录表。</p>
</blockquote>
<hr>
<p>接下来看看<code>Unix</code>的<code>I/O</code>模型，<code>Unix</code>提供5中<code>I/O</code>模型有以下几种。</p>
<hr>
<h3 id="阻塞I-O模型"><a href="#阻塞I-O模型" class="headerlink" title="阻塞I/O模型"></a>阻塞<code>I/O</code>模型</h3><blockquote>
<p>阻塞I/O模型是最常用的I/O模型， 在这个模型中，应用进程执行一个系统调用（recvfrom），其系统调用会一直阻塞，直到 数据包到达且被复制到应用进程的缓冲区或者发成错误才返回(解除阻塞)。 阻塞I/O模型的特点就是 进程从执行系统调用开始到返回的整个时间内都是被阻塞的，应用程序会一直等待直到收到系统响应（数据传输完成或发生错误）。</p>
</blockquote>
<p>如下图所示：<br><img src="/uploads/阻塞IO.png" alt="Alt text"></p>
<blockquote>
<p>阻塞I/O模型在IO执行的两个阶段都是阻塞的。</p>
<p>使用阻塞I/O模式开发简单，适合用于实现对少量文件描述符进行IO操作、或者需要及时返回数据的应用；</p>
<p>但是同时对大量文件描述符进行IO操作时，可以利用多线程技术进行处理，但是会造成大量的线程开销，增加系统的维护工作量，扩展性能很差。 </p>
</blockquote>
<hr>
<h3 id="非阻塞I-O模型"><a href="#非阻塞I-O模型" class="headerlink" title="非阻塞I/O模型"></a>非阻塞<code>I/O</code>模型</h3><blockquote>
<p>这种模型其实是阻塞<code>I/O</code>模型的一个变种。</p>
<p><code>recvfrom</code>从用户空间的应用层到内核的时候，如果缓冲区没有数据的话，就直接返回一个<code>EWOULDDBLOCK</code> 错误，也就是说非阻塞的<code>recvfrom</code>系统调用之后，进程并没有被阻塞，内核马上返回给进程（<code>EAGAIN</code>/<code>EWOULDDBLOCK</code>）。</p>
<p>一般都是对非阻塞<code>I/O</code>模型进行轮询检查这个状态，看内核是不是有数据到来。很显然，这样效率明显不高，因为应用程序需要进行忙碌等待，不断的轮训执行系统调用，上下文切换，<code>CPU</code>一直用在无谓的轮询上，消耗大量的<code>CPU</code>时间，最终降低整体数据吞吐量。需要注意的是：在数据拷贝过程中，进程仍然属于阻塞状态。</p>
</blockquote>
<p> 如下图所示：<br><img src="/uploads/非阻塞IO.png" alt="Alt text"></p>
<hr>
<h3 id="I-O-复用模型"><a href="#I-O-复用模型" class="headerlink" title="I/O 复用模型"></a><code>I/O</code> 复用模型</h3><blockquote>
<p><code>IO</code>复用模型 有几个特殊的系统调用（<code>select</code>、<code>poll</code>、<code>epoll</code>）函数。其基本原理就是,进程通过将一个或多个 <code>fd</code>/<code>socketfd</code> 传递给系统调用函数（<code>select</code>、<code>poll</code>、<code>epoll</code>），阻塞在<code>select</code> 操作上，这样 <code>select</code>/<code>poll</code> 可以帮助我们侦测多个 <code>fd</code>/<code>socketfd</code> 是否处于就绪状态。当其中有一个数据准备就绪，就能返回通知用户进程可读，然后进程再调用 recvfrom 系统调用，将数据由内核拷贝到用户进程，注意这个过程 是 阻塞的。</p>
<p>与阻塞<code>IO</code>的区别是，此时的<code>select</code> 不是等到 <code>socket</code>数据全部到达再处理，而是只要有数据到达就会通知用户进程，然后用户进程来处理。</p>
</blockquote>
<p>如下图所示。</p>
<p><img src="/uploads/多路IO复用模型.png" alt="Alt text"></p>
<blockquote>
<p><code>select</code>/<code>poll</code>   是顺序扫描 <code>fd</code>/<code>socketfd</code> 是否就绪，而且支持的 fd/socketfd 数量有限，因此它的使用受到一些限制。<code>epoll</code>  是基于事件驱动方式代替顺序扫描，性能更高，当<code>fd</code>/<code>socketfd</code>就绪时，立即返回函数<code>rollback</code>。</p>
<p>简单明了的说就是 相当于应用程序不用再轮训等待数据是否就绪，而是交给 <code>select</code>或<code>poll</code>或<code>epoll</code>  ， 在某个数据就绪时通知用户进程去操作。只不过 <code>select</code>或<code>poll</code>是顺序扫描<code>fd</code>，<code>epoll</code>是基于事件驱动，效率更高。</p>
<p><code>I/O</code> 多路复用技术通过把多个<code>I/O</code>的阻塞服用到同一个<code>select</code>的阻塞上，从而使得系统在单线程的情况下可以同时处理多个客户端请求。与传统的多线程多进程模型对比，<code>I/O</code>多路复用模型的的最大优势是系统开销小，不需要创建和维护新的额外进程或线程，降低里系统的维护工作量，节省了系统资源。   </p>
</blockquote>
<hr>
<h3 id="信号驱动I-O模型"><a href="#信号驱动I-O模型" class="headerlink" title="信号驱动I/O模型"></a>信号驱动<code>I/O</code>模型</h3><blockquote>
<p>首先开启套接口信号驱动<code>I/O</code>功能，并且通过系统调用<code>sigaction</code>执行一个信号处理函数（此系统调用立即返回，进程继续工作，它是非阻塞的）。当有数据准备就绪时，就为该进程生成一个<code>SIGIO</code>信号，通过信号回调通知应用程序调用<code>recvfrom</code>来读取数据，并通知应用程序处理数据。</p>
</blockquote>
<p> 如下图所示：</p>
<p><img src="/uploads/信号驱动IO模型.png" alt="Alt text"></p>
<hr>
<h3 id="异步-I-O"><a href="#异步-I-O" class="headerlink" title="异步 I/O"></a>异步 <code>I/O</code></h3><blockquote>
<p>   应用进程发起<code>aio_read</code>操作后，会立刻返回，并让内核在整个操作完成后（包括将数据从内核空间复制到用户空间）通知用户进程，告知用户进程操作已完成。</p>
<p>这种模式与信号驱动模式的区别是：信号驱动<code>I/O</code> 由内核通知用户进程何时可以开始一个<code>I/O</code>操作；异步<code>I/O</code> 模型由内核通知用户进程 <code>I/O</code>操作已经完成。</p>
</blockquote>
<p>如下图所示：</p>
<p><img src="/uploads/异步IO模型.png" alt="Alt text"></p>
<p>这大概就是异步非阻塞IO的原型。</p>
<hr>
<p> 五中<code>IO</code>模型对比：</p>
<blockquote>
<p>阻塞<code>I/O</code>：进程一直阻塞，直到数据拷贝完成<br>非阻塞<code>I/O</code> : 通过进程反复轮询（多次系统调用，并马上返回）；在数据拷贝的过程中，进程是阻塞的；<br><code>I/O</code>多路复用：主要是<code>select</code>，<code>poll</code>和<code>epoll</code>；对一个<code>I/O</code>端口，两次调用，两次返回，比阻塞<code>I/O</code>并没有什么优越性；关键是能实现同时对多个<code>I/O</code>端口进行监听；<br>信号驱动<code>I/O</code>：两次调用，两次返回；第一次调用立即返回，该过程非阻塞的。数据准备就绪后通知用户进程调用系统函数(<code>recvfrom</code>)来读取数据，期间进程是阻塞的；<br>异步<code>I/O</code>：数据拷贝的时候进程无需阻塞。数据的拷贝由内核完成后通知用户进程。</p>
<p>其中前四<code>I/O</code>模型都属于同步<code>I/O</code>模型范畴，只有第五种属于 异步<code>I/O</code>模型</p>
</blockquote>
<p><img src="/uploads/五中IO模型区别.png" alt="Alt text"></p>
<hr>
<h2 id="JAVA-NIO"><a href="#JAVA-NIO" class="headerlink" title="JAVA NIO"></a><code>JAVA NIO</code></h2><pre><code>JDK1.4推出之前，基于java的Socket通信都是采用 BIO模型(模型1.1)， JDK1.4 NIO的出现才开始支持I/O多路复用模型(模型1.3)，直到JDK7 才开始提供异步非阻塞模型(模型1.5)的支持。 
</code></pre><hr>
<h3 id="BIO"><a href="#BIO" class="headerlink" title="BIO"></a><code>BIO</code></h3><blockquote>
<p>采用BIO通信模型的服务端，通常由一个独立的Acceptor线程负责监听客户端的连接，它接收到客户端连接之后为每个客户端创建一个新的线程进行链路处理，处理完成之后，通过输出流返回应答给客户端，线程销毁。这就是典型  请求一应答 通信模型。通信模型如下：</p>
</blockquote>
<p><img src="/uploads/BIO.png" alt="Alt text"></p>
<p>该模型的开发示例如下：</p>
<blockquote>
<p><code>BioTimeServer.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> bio;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.net.ServerSocket;</div><div class="line"><span class="keyword">import</span> java.net.Socket;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Mr岳 on 16/10/30.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BioTimeServer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">int</span> port = <span class="number">8080</span>;</div><div class="line">        ServerSocket server = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            server = <span class="keyword">new</span> ServerSocket(port);</div><div class="line">            System.out.println(<span class="string">"The time server is start in port : "</span> + port);</div><div class="line">            Socket socket = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                <span class="comment">// 监听客户端连接,如果没有客户端接入,accept()方法将阻塞;如果监听到客户端链路接入,则创建一个新的线程处理</span></div><div class="line">                socket = server.accept();</div><div class="line">                <span class="keyword">new</span> Thread(<span class="keyword">new</span> BioTimeServerHandler(socket)).start();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (server != <span class="keyword">null</span>) &#123;</div><div class="line">                System.out.println(<span class="string">"The Time server done"</span>);</div><div class="line">                server.close();</div><div class="line">                server = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>BioTimeServerHandler.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> bio;</div><div class="line"><span class="keyword">import</span> java.io.BufferedReader;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.InputStreamReader;</div><div class="line"><span class="keyword">import</span> java.io.PrintWriter;</div><div class="line"><span class="keyword">import</span> java.net.Socket;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Mr岳 on 16/10/30.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BioTimeServerHandler</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Socket socket;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BioTimeServerHandler</span><span class="params">(Socket socket)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.socket = socket;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        BufferedReader in = <span class="keyword">null</span>;</div><div class="line">        PrintWriter out = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            in = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(<span class="keyword">this</span>.socket.getInputStream()));</div><div class="line">            out = <span class="keyword">new</span> PrintWriter(<span class="keyword">this</span>.socket.getOutputStream(), <span class="keyword">true</span>);<span class="comment">//接收客户端消息</span></div><div class="line">            String currentTime = <span class="keyword">null</span>;</div><div class="line">            String body = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                body = in.readLine();</div><div class="line">                <span class="keyword">if</span> (body == <span class="keyword">null</span>)<span class="keyword">break</span>;</div><div class="line">                System.out.println(<span class="string">"The time server receive order : "</span> + body);</div><div class="line">                currentTime = <span class="string">"QUERY TIME ORDER"</span>.equalsIgnoreCase(body) ? <span class="keyword">new</span> java.util.Date(System.currentTimeMillis()).toString() : <span class="string">"BAD ORDER"</span>;</div><div class="line">                out.println(currentTime);<span class="comment">// 发送消息给客户端</span></div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="comment">//关闭IO，socket</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>BioTimeClient.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> bio;</div><div class="line"><span class="keyword">import</span> java.io.BufferedReader;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.InputStreamReader;</div><div class="line"><span class="keyword">import</span> java.io.PrintWriter;</div><div class="line"><span class="keyword">import</span> java.net.Socket;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Mr岳 on 16/10/30.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BioTimeClient</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> port = <span class="number">8080</span>;</div><div class="line">        Socket socket = <span class="keyword">null</span>;</div><div class="line">        BufferedReader in = <span class="keyword">null</span>;</div><div class="line">        PrintWriter out = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            socket = <span class="keyword">new</span> Socket(<span class="string">"127.0.0.1"</span>, port);</div><div class="line">            in = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream()));</div><div class="line">            out = <span class="keyword">new</span> PrintWriter(socket.getOutputStream(), <span class="keyword">true</span>);</div><div class="line">            out.println(<span class="string">"QUERY TIME ORDER"</span>);<span class="comment">//发送消息给服务端</span></div><div class="line">            System.out.println(<span class="string">"Send order 2 server succeed."</span>);</div><div class="line">            String resp = in.readLine();</div><div class="line">            System.out.println(<span class="string">"Now is : "</span> + resp);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="comment">//关闭IO，socket</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行 <code>BioTimeServer</code> 和  <code>BioTimeClient</code> 后，你会发现 服务端<code>BioTimeServer</code> 在调用<code>ServerSocket.accept()</code>方法时，会一直阻塞，直到有客户端连接才会返回，每个客户端连接过来后，服务端都会启动一个线程去处理该客户端的请求。同样，客户端 <code>BioTimeClient</code>在调用 <code>InputStream.read()</code>方法时 也是一直阻塞的，直到数据到来时（或超时）才会返回。</p>
<p>该模型最大的问题就是每当有一个客户端请求接入时，服务端必须创建一个新的线程处理新接入的客户端链路，一个线程只能处理一个客户端连接。在高性能服务器应用领域，往往需要面向成千上万个客户端的并发链接，随着并发访问量的继续增大，系统将会发生线程堆栈溢出，创建新线程失败等问题，最终导致进程宕机或僵死，不能对外提供服务，这种模型显然无法满足高性能、高并发接入的应用场景。</p>
<p>不管是磁盘 <code>I/O</code> 还是网络 <code>I/O</code>，数据在写入 <code>OutputStream</code> 或者从 <code>InputStream</code> 读取时都有可能会阻塞。一旦有线程阻塞将会失去 <code>CPU</code> 的使用权，这在当前的大规模访问量和有性能要求情况下是不能接受的。虽然当前的网络 <code>I/O</code> 有一些解决办法，如一个客户端一个处理线程，出现阻塞时只是一个线程阻塞而不会影响其它线程工作。再比如： 为了减少系统线程的开销，采用线程池的办法来减少线程创建和回收的成本— 伪异步<code>IO</code></p>
</blockquote>
<hr>
<h3 id="伪异步I-O"><a href="#伪异步I-O" class="headerlink" title="伪异步I/O"></a>伪异步<code>I/O</code></h3><blockquote>
<p>伪异步I/O的后端通过一个线程池来处理多个客户端的请求接入，形成客户端个数M：线程池最大线程数N的比例关系，其中M可以远远大于N，通过线程池可以灵活的调配线程资源，设置线程的最大值，防止由于海量并发接入导致线程耗尽。如图，采用线程池 和任务队列实现伪异步I/O。</p>
<p>当有新的客户端接入的时候，将客户端的Socket封装成一个Task提交到线程池中进行处理，JDK的线程池维护一个消息队列和N个活跃线程对消息队列中的任务进行处理。由于线程池可以设置消息队列的大小和最大线程数，因此，它的资源占用是可控的，无论多少个客户端并发访问，都不会导致资源的耗尽和宕机。 </p>
</blockquote>
<p><img src="/uploads/N-NIO.png" alt="Alt text"></p>
<p>该模型的开发示例如下：<br><code>TimeServerHandlerExecutePool.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.net.ServerSocket;</div><div class="line"><span class="keyword">import</span> java.net.Socket;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Mr岳 on 16/10/30.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeServer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">int</span> port = <span class="number">8080</span>;</div><div class="line">        ServerSocket server = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            server = <span class="keyword">new</span> ServerSocket(port);</div><div class="line">            System.out.println(<span class="string">"The time server is start in port : "</span> + port);</div><div class="line">            Socket socket = <span class="keyword">null</span>;</div><div class="line">            TimeServerHandlerExecutePool singleExecutor = <span class="keyword">new</span> TimeServerHandlerExecutePool(<span class="number">50</span>, <span class="number">10000</span>);<span class="comment">// 创建IO任务线程池</span></div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                socket = server.accept();</div><div class="line">                singleExecutor.execute(<span class="keyword">new</span> TimeServerHandler(socket));</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="comment">// 关闭 server</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeServerHandlerExecutePool</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> ExecutorService executor;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TimeServerHandlerExecutePool</span><span class="params">(<span class="keyword">int</span> maxPoolSize, <span class="keyword">int</span> queueSize)</span> </span>&#123;</div><div class="line">       executor = <span class="keyword">new</span> ThreadPoolExecutor(Runtime.getRuntime().availableProcessors(), maxPoolSize, <span class="number">120L</span>, TimeUnit.SECONDS,<span class="keyword">new</span> ArrayBlockingQueue(queueSize));</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(java.lang.Runnable task)</span> </span>&#123;</div><div class="line">        executor.execute(task);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>伪异步<code>I/O</code>通信框架实际上仅仅只是对之前<code>I/O</code>线程模型的一个简单优化，虽然采用了线程池实现，但是由于它底层的通信依然采用同步阻塞模型，因此无法从根本上解决问题。</p>
<blockquote>
<p>试想如果出现一下几种情况时会发生什么</p>
<ul>
<li>服务端处理慢，响应时间过长</li>
<li>队列积满</li>
<li>客户端连接超时</li>
</ul>
</blockquote>
<p>这其实是一个连锁反应，由于服务端处理缓慢，导致客户端响应变慢，此时将会出现大量的队列堆积，积满之后，入队列发生阻塞，此时就会出现大量的客户端连接超时，此时调用者会认为系统已经崩溃，无法接收新的请求消息。。</p>
<hr>
<h3 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a><code>NIO</code></h3><p><code>JDK1.4</code>提供了对非阻塞<code>IO</code>（<code>NIO</code>）的支持，它是基于<code>I/O</code>多路复用模型实现的非阻塞<code>I/O</code>，底层是基于<code>select</code>/<code>poll</code>模型实现的，<code>JDK1.5_update10</code>版本对该模型进行优化，使用<code>epoll</code>替代了传统的<code>select</code>/<code>poll</code>，上层<code>API</code>并没有发生变化，极大的提升了<code>NIO</code>通信的性能。<br>其中引入了新的<code>I/O</code>类库和一些新的概念：</p>
<blockquote>
<ul>
<li><code>缓冲区Buffer</code>： <code>Buffer</code>是一个对象，简单来说，它包含要写入或者要读出的数据。在<code>NIO</code>类库中，任何对<code>NIO</code>数据的读写，都是通过缓冲区进行操作的。</li>
<li><code>通道Channel</code> ：通过<code>Channel</code>我们可以读取和写入数据到缓冲区。也可以这么说：通道用于在缓冲区和位于通道另一侧的实体（文件、套接字）之间有效的传输数据。</li>
</ul>
</blockquote>
<p>还有一点需要知道的是 ： <code>Channel和Stream</code>的不同之处就在于<code>Channel</code>是全双工的，即双向的，可以用于读和写。</p>
<blockquote>
<ul>
<li><code>多路复用器Selector</code>  ：就是上面(<code>LinuxI/O</code>多路复用模型)提到的多路复用器。<code>Selector</code>会不断的轮询注册在其上的<code>Channel</code>，如果某个<code>Channel</code>上面有新的<code>TCP</code>连接接入、读或者写事件， 这个<code>Channel</code>就处于就绪状态，会被<code>Selector</code> 轮询出来，然后通过<code>SelectorKey</code>可以获得就绪的Channel，进行后续的I/O操作。</li>
</ul>
</blockquote>
<p><img src="/uploads/NIO-Reactor单线程模型.png" alt="Alt text"></p>
<p>该模型的开发示例如下：</p>
<p><code>NioTimeServer.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> nio;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Mr岳 on 16/10/30.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NioTimeServer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">int</span> port = <span class="number">8080</span>;</div><div class="line">        MultiplexerTimeServer timeServer = <span class="keyword">new</span> MultiplexerTimeServer(port);</div><div class="line">        <span class="keyword">new</span> Thread(timeServer, <span class="string">"NIO-MultiplexerTimeServer-001"</span>).start();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">``` </div><div class="line">`MultiplexerTimeServer.java`</div><div class="line">```java</div><div class="line"><span class="keyword">package</span> nio;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</div><div class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</div><div class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</div><div class="line"><span class="keyword">import</span> java.nio.channels.Selector;</div><div class="line"><span class="keyword">import</span> java.nio.channels.ServerSocketChannel;</div><div class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</div><div class="line"><span class="keyword">import</span> java.util.Iterator;</div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Mr岳 on 16/10/30.</div><div class="line"> * 多路复用类,负载轮询多路复用器Selector,可以处理多个客户端的并发接入</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiplexerTimeServer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Selector selector;</div><div class="line">    <span class="keyword">private</span> ServerSocketChannel servChannel;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> stop;</div><div class="line">    <span class="comment">//初始化多路复用器、绑定监听端口</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MultiplexerTimeServer</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 创建多路复用器</span></div><div class="line">            selector = Selector.open();</div><div class="line">            <span class="comment">//打开ServerSocketChannel,监听客户端连接</span></div><div class="line">            servChannel = ServerSocketChannel.open();</div><div class="line">            <span class="comment">//设置连接为非阻塞模式</span></div><div class="line">            servChannel.configureBlocking(<span class="keyword">false</span>);</div><div class="line">            servChannel.socket().bind(<span class="keyword">new</span> InetSocketAddress(port), <span class="number">1024</span>);</div><div class="line">            <span class="comment">//将ServerSocketChannel注册到多路复用器Selector上,监听OP_ACCEPT事件</span></div><div class="line">            servChannel.register(selector, SelectionKey.OP_ACCEPT);</div><div class="line">            System.out.println(<span class="string">"The time server is start in port : "</span> + port);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">            System.exit(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (!stop) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                selector.select(<span class="number">1000</span>);<span class="comment">//这里依然是阻塞的</span></div><div class="line">                Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</div><div class="line">                Iterator&lt;SelectionKey&gt; it = selectedKeys.iterator();</div><div class="line">                SelectionKey key = <span class="keyword">null</span>;</div><div class="line">                <span class="comment">//轮询准备就绪的SelectionKey,返回就绪状态的SocketChannel的SelectionKey集合</span></div><div class="line">                <span class="keyword">while</span> (it.hasNext()) &#123;</div><div class="line">                    key = it.next();</div><div class="line">                    it.remove();</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        handleInput(key);</div><div class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                        <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</div><div class="line">                            key.cancel();</div><div class="line">                            <span class="keyword">if</span> (key.channel() != <span class="keyword">null</span>)</div><div class="line">                                key.channel().close();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                t.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 多路复用器关闭后，所有注册在上面的Channel和Pipe等资源都会被自动去注册并关闭，所以不需要重复释放资源</span></div><div class="line">        <span class="keyword">if</span> (selector != <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                selector.close();</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleInput</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (key.isValid()) &#123;</div><div class="line">            <span class="comment">//处理新接入的请求消息</span></div><div class="line">            <span class="keyword">if</span> (key.isAcceptable()) &#123;</div><div class="line">                <span class="comment">//接入新的请求,并建立连接</span></div><div class="line">                ServerSocketChannel ssc = (ServerSocketChannel) key.channel();</div><div class="line">                SocketChannel sc = ssc.accept();</div><div class="line">                sc.configureBlocking(<span class="keyword">false</span>);</div><div class="line">                <span class="comment">//将新的客户端ServerSocketChannel注册到Selector,并监听读操作</span></div><div class="line">                sc.register(selector, SelectionKey.OP_READ);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (key.isReadable()) &#123;</div><div class="line">                <span class="comment">//异步读取消息到缓冲区ByteBuffer</span></div><div class="line">                SocketChannel sc = (SocketChannel) key.channel();</div><div class="line">                ByteBuffer readBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</div><div class="line">                <span class="keyword">int</span> readBytes = sc.read(readBuffer);</div><div class="line">                <span class="keyword">if</span> (readBytes &gt; <span class="number">0</span>) &#123;</div><div class="line">                    readBuffer.flip();</div><div class="line">                    <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[readBuffer.remaining()];</div><div class="line">                    readBuffer.get(bytes);</div><div class="line">                    String body = <span class="keyword">new</span> String(bytes, <span class="string">"UTF-8"</span>);</div><div class="line">                    System.out.println(<span class="string">" The time server receive order:"</span> + body);</div><div class="line">                  String currentTime = <span class="string">"QUERY TIME ORDER"</span>.equalsIgnoreCase(body) ? <span class="keyword">new</span> java.util.Date(System.currentTimeMillis()).toString() : <span class="string">"BAD ORDER"</span>;</div><div class="line">                    doWrite(sc, currentTime);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (readBytes &lt; <span class="number">0</span>) &#123;</div><div class="line">                    <span class="comment">// 对端链路关闭</span></div><div class="line">                    key.cancel();</div><div class="line">                    sc.close();</div><div class="line">                &#125; <span class="keyword">else</span></div><div class="line">                    ; <span class="comment">// 读到0字节，忽略</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 将消息发送给客户端</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doWrite</span><span class="params">(SocketChannel channel, String response)</span><span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (response != <span class="keyword">null</span> &amp;&amp; response.trim().length() &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">byte</span>[] bytes = response.getBytes();</div><div class="line">            ByteBuffer writeBuffer = ByteBuffer.allocate(bytes.length);</div><div class="line">            writeBuffer.put(bytes);</div><div class="line">            writeBuffer.flip();</div><div class="line">            channel.write(writeBuffer);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.stop = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>NioTimeClient.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> nio;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Mr岳 on 16/10/30.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NioTimeClient</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> port = <span class="number">8080</span>;</div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> NioTimeClientHandle(<span class="string">"127.0.0.1"</span>, port), <span class="string">"NioTimeClient-001"</span>).start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>NioTimeClientHandle.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> nio;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</div><div class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</div><div class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</div><div class="line"><span class="keyword">import</span> java.nio.channels.Selector;</div><div class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</div><div class="line"><span class="keyword">import</span> java.util.Iterator;</div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Mr岳 on 16/10/30.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NioTimeClientHandle</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String host;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</div><div class="line">    <span class="keyword">private</span> Selector selector;</div><div class="line">    <span class="keyword">private</span> SocketChannel socketChannel;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> stop;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NioTimeClientHandle</span><span class="params">(String host, <span class="keyword">int</span> port)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.host = host == <span class="keyword">null</span> ? <span class="string">"127.0.0.1"</span> : host;</div><div class="line">        <span class="keyword">this</span>.port = port;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            selector = Selector.open();</div><div class="line">            socketChannel = SocketChannel.open();</div><div class="line">            socketChannel.configureBlocking(<span class="keyword">false</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">            System.exit(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            doConnect();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">            System.exit(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">while</span> (!stop) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                selector.select(<span class="number">1000</span>);<span class="comment">//这里依然是阻塞的</span></div><div class="line">                Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</div><div class="line">                Iterator&lt;SelectionKey&gt; it = selectedKeys.iterator();</div><div class="line">                SelectionKey key = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">while</span> (it.hasNext()) &#123;</div><div class="line">                    key = it.next();</div><div class="line">                    it.remove();</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        handleInput(key);</div><div class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                        <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</div><div class="line">                            key.cancel();</div><div class="line">                            <span class="keyword">if</span> (key.channel() != <span class="keyword">null</span>)</div><div class="line">                                key.channel().close();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">                System.exit(<span class="number">1</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 多路复用器关闭后，所有注册在上面的Channel和Pipe等资源都会被自动去注册并关闭，所以不需要重复释放资源</span></div><div class="line">        <span class="keyword">if</span> (selector != <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                selector.close();</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleInput</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (key.isValid()) &#123;</div><div class="line">            <span class="comment">// 判断是否连接成功</span></div><div class="line">            SocketChannel sc = (SocketChannel) key.channel();</div><div class="line">            <span class="keyword">if</span> (key.isConnectable()) &#123;</div><div class="line">                <span class="keyword">if</span> (sc.finishConnect()) &#123;</div><div class="line">                    sc.register(selector, SelectionKey.OP_READ);</div><div class="line">                    doWrite(sc);</div><div class="line">                &#125; <span class="keyword">else</span></div><div class="line">                    System.exit(<span class="number">1</span>);<span class="comment">// 连接失败，进程退出</span></div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (key.isReadable()) &#123;</div><div class="line">                ByteBuffer readBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</div><div class="line">                <span class="keyword">int</span> readBytes = sc.read(readBuffer);</div><div class="line">                <span class="keyword">if</span> (readBytes &gt; <span class="number">0</span>) &#123;</div><div class="line">                    readBuffer.flip();</div><div class="line">                    <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[readBuffer.remaining()];</div><div class="line">                    readBuffer.get(bytes);</div><div class="line">                    String body = <span class="keyword">new</span> String(bytes, <span class="string">"UTF-8"</span>);</div><div class="line">                    System.out.println(<span class="string">"Now is : "</span> + body);</div><div class="line">                    <span class="keyword">this</span>.stop = <span class="keyword">true</span>;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (readBytes &lt; <span class="number">0</span>) &#123;</div><div class="line">                    <span class="comment">// 对端链路关闭</span></div><div class="line">                    key.cancel();</div><div class="line">                    sc.close();</div><div class="line">                &#125; <span class="keyword">else</span></div><div class="line">                    ; <span class="comment">// 读到0字节，忽略</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doConnect</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="comment">// 如果直接连接成功，则注册到多路复用器上，发送请求消息，读应答</span></div><div class="line">        <span class="keyword">if</span> (socketChannel.connect(<span class="keyword">new</span> InetSocketAddress(host, port))) &#123;</div><div class="line">            socketChannel.register(selector, SelectionKey.OP_READ);</div><div class="line">            doWrite(socketChannel);</div><div class="line">        &#125; <span class="keyword">else</span></div><div class="line">            socketChannel.register(selector, SelectionKey.OP_CONNECT);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doWrite</span><span class="params">(SocketChannel sc)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">byte</span>[] req = <span class="string">"QUERY TIME ORDER"</span>.getBytes();</div><div class="line">        ByteBuffer writeBuffer = ByteBuffer.allocate(req.length);</div><div class="line">        writeBuffer.put(req);</div><div class="line">        writeBuffer.flip();</div><div class="line">        sc.write(writeBuffer);</div><div class="line">        <span class="keyword">if</span> (!writeBuffer.hasRemaining())</div><div class="line">            System.out.println(<span class="string">"Send order 2 server succeed."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们不难发现<code>BIO</code>与<code>NIO</code>有如下不同之处：</p>
<blockquote>
<ul>
<li>编码复杂度很显然高与<code>BIO</code></li>
<li>传统<code>IO(BIO)</code>在 进行读写时，需要阻塞直到可读或写。而<code>NIO</code>客户端发起的连接操作是异步的，可以通过在多路复用器上注册 <code>OP_CONNECT</code>等待后续结果，不需要像<code>BIO</code>那样被同步阻塞。</li>
<li><code>NIO</code>都是通过缓冲区<code>Buffer</code>进行读写操作的</li>
<li><code>SocketChannel</code> 的读写是全双工且异步的，如果没有可读或可写的数据它不会同步等待，直接返回，这样<code>IO</code>通信线程就可以处理其它的链路，不需要同步等待这个链路可用</li>
<li>从阻塞<code>I/O</code> 和 多路复用<code>I/O</code>的模型模型图中可以看出，他们并没有太大的区别，只是多一步 在<code>Selector</code>上注册连接/读/写事件（<code>servChannel.register</code>），以及调用<code>select</code>函数的额外操作，效率更差。</li>
</ul>
</blockquote>
<pre><code>由于JDK的`Selector`在`Linux`等主流操作系统上通过`epoll`实现，它没有连接句柄数的限制（只受限于操作系统的最大句柄数或者对单个进程的句柄限制），这意味着一个`Selector`线程可以同时处理成千上万个客户端连接，而且性能不会随着客户端的增加而线性下降，因此，它非常适合做高性能、高负载的网络服务器。而在阻塞`I/O`模型中，必须通过多线程的方式才能达到这个目的。

 在`JDK1.4`时，`Selector`是基于`I/O`多路复用模型的 `select/poll`实现的，在`JDK1.5`的时候，底层使用epoll模型对其进行性能优化，但是本质上还是非阻塞`I/O`。
</code></pre><hr>
<p>###<code>AIO</code></p>
<p><code>JDK1.7</code> 又对<code>NIO</code>进行了升级，是很正的异步非阻塞<code>I/O</code>，它提供了 与<code>Unix</code>网络编程事件驱动<code>IO</code>对应的<code>AIO</code>，它不需要多路复用器<code>Selector</code>对注册的通过<code>Channel</code>进行轮询操作即可实现异步读写，从而简化了<code>NIO</code>编程。<br><code>NIO</code>是在有数据准备就绪后，就返回通知用户进程进行可读/写，然后用户进程再调用<code>recvfrom</code>系统调用，将数据由内核拷贝到用户进程。而 <code>AIO</code>是在 <code>IO</code>操作已经完成后，再给用户进程发出通知。因此<code>AIO</code>是非阻塞的。<br>该模型的开发示例如下：</p>
<p><code>AioTimeServer.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> aio;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Mr岳 on 16/10/30.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AioTimeServer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">int</span> port = <span class="number">8080</span>;</div><div class="line">        AioTimeServerHandler timeServer = <span class="keyword">new</span> AioTimeServerHandler(port);</div><div class="line">        <span class="keyword">new</span> Thread(timeServer, <span class="string">"AIO-AioTimeServerHandler-001"</span>).start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>AioTimeServerHandler.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> aio;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</div><div class="line"><span class="keyword">import</span> java.nio.channels.AsynchronousServerSocketChannel;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Mr岳 on 16/10/30.</div><div class="line"> * 异步IO TimeServerHandler</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AioTimeServerHandler</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</div><div class="line">    CountDownLatch latch;</div><div class="line">    AsynchronousServerSocketChannel asynchronousServerSocketChannel;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AioTimeServerHandler</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.port = port;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 创建异步的服务端SocketChannel</span></div><div class="line">            asynchronousServerSocketChannel = AsynchronousServerSocketChannel.open();</div><div class="line">            asynchronousServerSocketChannel.bind(<span class="keyword">new</span> InetSocketAddress(port));</div><div class="line">            System.out.println(<span class="string">"The time server is start in port : "</span> + port);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// CountDownLatch的作用是在完成一组正在执行的操作之前,允许当前的线程一直阻塞。</span></div><div class="line">        latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</div><div class="line">        doAccept();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            latch.await();</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAccept</span><span class="params">()</span> </span>&#123;</div><div class="line">        asynchronousServerSocketChannel.accept(<span class="keyword">this</span>,<span class="keyword">new</span> AcceptCompletionHandler());<span class="comment">//接收客户端的请求连接，并指定事件处理类==回调函数</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>AcceptCompletionHandler.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> aio;</div><div class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</div><div class="line"><span class="keyword">import</span> java.nio.channels.AsynchronousSocketChannel;</div><div class="line"><span class="keyword">import</span> java.nio.channels.CompletionHandler;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Mr岳 on 16/10/30.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AcceptCompletionHandler</span> <span class="keyword">implements</span> <span class="title">CompletionHandler</span>&lt;<span class="title">AsynchronousSocketChannel</span>, <span class="title">AioTimeServerHandler</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(AsynchronousSocketChannel result, AioTimeServerHandler attachment)</span> </span>&#123;</div><div class="line">        <span class="comment">//继续接收其他客户端的连接</span></div><div class="line">        attachment.asynchronousServerSocketChannel.accept(attachment, <span class="keyword">this</span>);</div><div class="line">        ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</div><div class="line">        <span class="comment">//接收并处理客户端的请求消息</span></div><div class="line">        result.read(buffer, buffer, <span class="keyword">new</span> ReadCompletionHandler(result));</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, AioTimeServerHandler attachment)</span> </span>&#123;</div><div class="line">        exc.printStackTrace();</div><div class="line">        attachment.latch.countDown();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>ReadCompletionHandler.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> aio;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</div><div class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</div><div class="line"><span class="keyword">import</span> java.nio.channels.AsynchronousSocketChannel;</div><div class="line"><span class="keyword">import</span> java.nio.channels.CompletionHandler;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Mr岳 on 16/10/30.</div><div class="line"> * 事件处理类==回调函数，分别在异步操作成功和失败时被回调。</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadCompletionHandler</span> <span class="keyword">implements</span> <span class="title">CompletionHandler</span>&lt;<span class="title">Integer</span>, <span class="title">ByteBuffer</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> AsynchronousSocketChannel channel;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReadCompletionHandler</span><span class="params">(AsynchronousSocketChannel channel)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.channel == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">this</span>.channel = channel;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(Integer result, ByteBuffer attachment)</span> </span>&#123;</div><div class="line">        attachment.flip();</div><div class="line">        <span class="keyword">byte</span>[] body = <span class="keyword">new</span> <span class="keyword">byte</span>[attachment.remaining()];</div><div class="line">        attachment.get(body);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            String req = <span class="keyword">new</span> String(body, <span class="string">"UTF-8"</span>);</div><div class="line">            System.out.println(<span class="string">"The time server receive order : "</span> + req);</div><div class="line">            String currentTime = <span class="string">"QUERY TIME ORDER"</span>.equalsIgnoreCase(req) ?</div><div class="line">                    <span class="keyword">new</span> java.util.Date(System.currentTimeMillis()).toString() : <span class="string">"BAD ORDER"</span>;</div><div class="line">            doWrite(currentTime);</div><div class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doWrite</span><span class="params">(String currentTime)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (currentTime != <span class="keyword">null</span> &amp;&amp; currentTime.trim().length() &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">byte</span>[] bytes = (currentTime).getBytes();</div><div class="line">            ByteBuffer writeBuffer = ByteBuffer.allocate(bytes.length);</div><div class="line">            writeBuffer.put(bytes);</div><div class="line">            writeBuffer.flip();</div><div class="line">            <span class="comment">// 异步write方法</span></div><div class="line">            channel.write(writeBuffer, writeBuffer,<span class="keyword">new</span> CompletionHandler&lt;Integer, ByteBuffer&gt;() &#123;</div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(Integer result, ByteBuffer buffer)</span> </span>&#123;</div><div class="line">                            <span class="comment">// 如果没有发送完成，继续发送</span></div><div class="line">                            <span class="keyword">if</span> (buffer.hasRemaining())</div><div class="line">                                channel.write(buffer, buffer, <span class="keyword">this</span>);</div><div class="line">                        &#125;</div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, ByteBuffer attachment)</span> </span>&#123;</div><div class="line">                            <span class="keyword">try</span> &#123;</div><div class="line">                                channel.close();</div><div class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                                e.printStackTrace();</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, ByteBuffer attachment)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">this</span>.channel.close();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>AioTimeClient.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> aio;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Mr岳 on 16/10/30.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AioTimeClient</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> port = <span class="number">8080</span>;</div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> AioTimeClientHandler(<span class="string">"127.0.0.1"</span>, port),<span class="string">"AIO-AioTimeClientHandler-001"</span>).start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>AioTimeClientHandler.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> aio;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</div><div class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</div><div class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</div><div class="line"><span class="keyword">import</span> java.nio.channels.AsynchronousSocketChannel;</div><div class="line"><span class="keyword">import</span> java.nio.channels.CompletionHandler;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Mr岳 on 16/10/30.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AioTimeClientHandler</span> <span class="keyword">implements</span> <span class="title">CompletionHandler</span>&lt;<span class="title">Void</span>, <span class="title">AioTimeClientHandler</span>&gt;, <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> AsynchronousSocketChannel client;</div><div class="line">    <span class="keyword">private</span> String host;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</div><div class="line">    <span class="keyword">private</span> CountDownLatch latch;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AioTimeClientHandler</span><span class="params">(String host, <span class="keyword">int</span> port)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.host = host;</div><div class="line">        <span class="keyword">this</span>.port = port;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//  创建异步的客户端SocketChannel</span></div><div class="line">            client = AsynchronousSocketChannel.open();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</div><div class="line">        client.connect(<span class="keyword">new</span> InetSocketAddress(host, port), <span class="keyword">this</span>, <span class="keyword">this</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            latch.await();</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e1) &#123;</div><div class="line">            e1.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            client.close();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(Void result, AioTimeClientHandler attachment)</span> </span>&#123;</div><div class="line">        <span class="keyword">byte</span>[] req = <span class="string">"QUERY TIME ORDER"</span>.getBytes();</div><div class="line">        ByteBuffer writeBuffer = ByteBuffer.allocate(req.length);</div><div class="line">        writeBuffer.put(req);</div><div class="line">        writeBuffer.flip();</div><div class="line">        client.write(writeBuffer, writeBuffer, <span class="keyword">new</span> CompletionHandler&lt;Integer, ByteBuffer&gt;() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(Integer result, ByteBuffer buffer)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (buffer.hasRemaining()) &#123;</div><div class="line">                    client.write(buffer, buffer, <span class="keyword">this</span>);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    ByteBuffer readBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</div><div class="line">                    client.read(readBuffer, readBuffer, <span class="keyword">new</span> CompletionHandler&lt;Integer, ByteBuffer&gt;() &#123;</div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(Integer result, ByteBuffer buffer)</span> </span>&#123;</div><div class="line">                            buffer.flip();</div><div class="line">                            <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[buffer.remaining()];</div><div class="line">                            buffer.get(bytes);</div><div class="line">                            String body;</div><div class="line">                            <span class="keyword">try</span> &#123;</div><div class="line">                                body = <span class="keyword">new</span> String(bytes, <span class="string">"UTF-8"</span>);</div><div class="line">                                System.out.println(<span class="string">"Now is : "</span> + body);</div><div class="line">                                latch.countDown();</div><div class="line">                            &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">                                e.printStackTrace();</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, ByteBuffer attachment)</span> </span>&#123;</div><div class="line">                            <span class="keyword">try</span> &#123;</div><div class="line">                                client.close();</div><div class="line">                                latch.countDown();</div><div class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                                e.printStackTrace();</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, ByteBuffer attachment)</span> </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    client.close();</div><div class="line">                    latch.countDown();</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, AioTimeClientHandler attachment)</span> </span>&#123;</div><div class="line">        exc.printStackTrace();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            client.close();</div><div class="line">            latch.countDown();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<p>参考 ：<br>1、<a href="http://gee.cs.oswego.edu/dl/cpjslides/nio.pdf" target="_blank" rel="external">Scalable IO in Java</a><br>2、《Unix网络编程》</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/07/18/Redis批量插入/" rel="next" title="Redis批量插入">
                <i class="fa fa-chevron-left"></i> Redis批量插入
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        
<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/11/12/JAVA-NIO-模型/"
           data-title="JAVA NIO 模型" data-url="http://yoursite.com/2016/11/12/JAVA-NIO-模型/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/头像.jpg"
               alt="Mr岳" />
          <p class="site-author-name" itemprop="name">Mr岳</p>
          <p class="site-description motion-element" itemprop="description">There are no two identical leaves in the world.</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">6</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/fengshao0907" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/3085325177/profile" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/xiaoxiaoye" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://macshuo.com/" title="MacTalk" target="_blank">MacTalk</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://hedengcheng.com/" title="HeDengCheng" target="_blank">HeDengCheng</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://mysql.taobao.org/monthly/2016/06/" title="数据库内核月报" target="_blank">数据库内核月报</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://es.xiaoleilu.com/" title="ElasticSearch" target="_blank">ElasticSearch</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#JAVA-NIO-模型"><span class="nav-number">1.</span> <span class="nav-text">JAVA NIO 模型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux-网络-I-O-模型"><span class="nav-number">1.1.</span> <span class="nav-text">Linux 网络 I/O 模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#阻塞I-O模型"><span class="nav-number">1.1.1.</span> <span class="nav-text">阻塞I/O模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#非阻塞I-O模型"><span class="nav-number">1.1.2.</span> <span class="nav-text">非阻塞I/O模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#I-O-复用模型"><span class="nav-number">1.1.3.</span> <span class="nav-text">I/O 复用模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#信号驱动I-O模型"><span class="nav-number">1.1.4.</span> <span class="nav-text">信号驱动I/O模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异步-I-O"><span class="nav-number">1.1.5.</span> <span class="nav-text">异步 I/O</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JAVA-NIO"><span class="nav-number">1.2.</span> <span class="nav-text">JAVA NIO</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BIO"><span class="nav-number">1.2.1.</span> <span class="nav-text">BIO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#伪异步I-O"><span class="nav-number">1.2.2.</span> <span class="nav-text">伪异步I/O</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NIO"><span class="nav-number">1.2.3.</span> <span class="nav-text">NIO</span></a></li></ol></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mr岳</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"fengshao0907"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>
  <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("kTtTzkfBK0h3Db6QELtFmMYq-gzGzoHsz", "7iLht0UC6uCiSqVTjzy8QUc4");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

</body>
</html>
